<!DOCTYPE html>
<html>

<script src="dist/jquery-3.4.1.min.js"></script>
<script land="javascript" src="dist/xlsx.full.min.js"></script>
<script land="javascript" src="dist/FileSaver.min.js"></script>

<head>
    <title>Convert Wireshark to Excel</title>
</head>

<body>

    <h1>Convert Wireshark to Excel</h1>
    <p>Choose PDML file</p>
    <input type="file" id="wsFile" name="wsFile"><br>
    <button id="button-save">Save XLSX file</button>

    <br>
    <p id="statusCheck"></p>
    <br>
    <div id="progress_bar">
        <div class="percent">
            0%
        </div>
    </div>
    <br>
    <!-- <p id="AmountPackets">-</p>
    <br>
    <p id="AmountFields">-</p>
    <br>
    <p id="AmountCstInfos">-</p> -->
    <div id=myTable></div>



</body>
<script>
    function CreateTable() {
        var myTable = '<table style="width:100%"'
        var rows = 4;
        var cols = 10;

        myTable += '<tr>';
        myTable +=
            '<th>Frame Number</th>' +
            '<th>Frame Arrival</th>' +
            '<th>CstLabel</th>' +
            '<th>CstLabels</th>' +
            '<th>Vehicle Model</th>' +
            '<th>CarTypes</th>' +
            '<th>BlockId</th>' +
            '<th>Driving Direction</th>' +
            '<th>Current StationID</th>' +
            '<th>Current Station</th>' +
            '<th>Next Station</th>' +
            '<th>Next StationID</th>' +
            '<th>Distance To Next StationM</th>' +
            '<th>Destination Station</th>' +
            '<th>Destination StationID</th>' +
            '<th>Door Open </th>' +
            '<th>Doors Closed </th>' +
            '<th>Has Changed </th>' +
            '<th>Last Updated </th>' +
            '<th>Max Number Of Streams </th>'
        myTable += '</tr>';

        console.log(ws_data)
        console.log(ws_data.length)
        console.log(ws_data)
        console.log(ws_data[1])

        for (var r = 0; r < ws_data.length; r++) {
            myTable += '<tr>';

            for (var c = 0; c < ws_data[r].length; c++) {
                myTable += '<td>' + ws_data[r][c] + '</td>';
            }
            myTable += '</tr>';
        }
        myTable += '</table>'

        document.getElementById('myTable').innerHTML = myTable
    }


    stationNames = ["Slussen", "Gamla stan", "T-Centralen", "Hötorget", "Rådmansgatan", "Odenplan", "S:t Eriksplan",
        "Fridhemsplan", "Thorildsplan", "Kristineberg", "Alvik", "Stora mossen", "Abrahamsberg", "Brommaplan",
        "Åkeshov", "Ängbyplan", "Islandstorget", "Blackeberg", "Råcksta", "Vällingby", "Johannelund",
        "Hässelby gård", "Hässelby strand", "Medborgarplatsen", "Skanstull", "Gullmarsplan", "Skärmarbrink",
        "Globen", "Enskede gård", "Sockenplan", "Svedmyra", "Stureby", "Bandhagen", "Högdalen", "Rågsved",
        "Hagsätra", "Blåsut", "Sandsborg", "Skogskyrkogården", "Tallkrogen", "Gubbängen", "Hökarängen", "Farsta",
        "Farsta strand", "Hammarbyhöjden", "Björkhagen", "Kärrtorp", "Bagarmossen", "Skarpnäck",
        "Östermalmstorg", "Karlaplan", "Gärdet", "Ropsten", "Stadion", "Tekniska högskolan", "Universitetet",
        "Bergshamra", "Danderyds sjukhus", "Mörby centrum", "Mariatorget", "Zinkensdamm", "Hornstull",
        "Liljeholmen", "Aspudden", "Örnsberg", "Axelsberg", "Mälarhöjden", "Bredäng", "Sätra", "Skärholmen",
        "Vårberg", "Vårby gård", "Masmo", "Fittja", "Alby", "Hallunda", "Norsborg", "Midsommarkransen",
        "Telefonplan", "Hägerstensåsen", "Västertorp", "Fruängen", "Kungsträdgården", "Rådhuset", "Stadshagen",
        "Västra skogen", "Solna centrum", "Näckrosen", "Hallonbergen", "Kymlinge norrut", "Kista", "Husby",
        "Akalla", "Huvudsta", "Solna strand", "Sundbybergs centrum", "Duvbo", "Rissne", "Rinkeby", "Tensta",
        "Hjulsta",
    ]
    stationNumber = ["1011", "1021", "1051", "1111", "1121", "1131", "1141", "1151", "1161", "1171", "1201", "1211",
        "1221", "1231", "1241", "1251", "1261", "1271", "1281", "1301", "1311", "1321", "1331", "1511", "1521",
        "1551", "1601", "1611", "1621", "1631", "1641", "1651", "1661", "1701", "1711", "1721", "1811", "1821",
        "1831", "1841", "1851", "1861", "1871", "1881", "1911", "1921", "1931", "1941", "1951", "2101",
        "2111", "2121", "2131", "2211", "2221", "2231", "2241", "2251", "2301", "2511", "2521", "2531", "2601",
        "2611", "2621", "2631", "2641", "2651", "2701", "2711", "2721", "2731", "2741", "2751", "2761", "2771",
        "2781", "2811", "2821", "2831", "2841", "2851", "3031", "3131", "3161", "3201", "3211", "3221", "3231",
        "3241", "3251", "3261", "3271", "3411", "3421", "3431", "3441", "3451", "3461", "3471", "3481"
    ]

    var wsFile = document.getElementById('wsFile');
    var ws_data = []


    // ------ get infos funktioner --------------
    function GetStationName(x) {
        stationID = "" + x.charAt(-4) + x.charAt(-3) + x.charAt(-2) + x.charAt(-1)

        stationNumber.forEach((station, index) => {
            if (station == stationID) {
                x = stationNames[index]
            }
        });
        return x
    }

    function CstLabel(x) {
        x = x.split("CstLabel")
        x = x[1].replace(">", "").replace("</", "")
        x = x.charAt(10) + x.charAt(11) + x.charAt(12) + x.charAt(13)
        return x
    }

    function CstLabels(x) {
        x = x.split("CstLabels")
        x = x[1].replace("</b:string>", "").split("<b:string>")
        x.shift()
        cars = ""
        x.forEach(car => {
            car = car.charAt(10) + car.charAt(11) + car.charAt(12) + car.charAt(13)
            cars += car.replace("</", "") + " "
        });
        return cars
    }

    function VehicleModel(x) {
        x = x.split("VehicleModel")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function CarTypes(x) {
        x = x.split("CarTypes")
        x = x[1].replace("</b:string>", "").split("<b:string>")
        x.shift()
        cars = ""
        x.forEach(car => {
            cars = cars + car.replace("</", "") + ""
        });
        return x
    }

    function BlockId(x) {
        x = x.split("BlockId")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function DrivingDirection(x) {
        x = x.split("DrivingDirection")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function CurrentStationID(x) {
        x = x.split("CurrentStation")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function CurrentStation(x) {
        x = x.split("CurrentStation")
        x = x[1].replace(">", "").replace("</", "")
        x = GetStationName(x)
        return x
    }

    function NextStation(x) {
        x = x.replace("DistanceToNextStationM", "")
        x = x.split("NextStation")
        x = x[1].replace(">", "").replace("</", "")
        x = GetStationName(x)
        return x
    }

    function NextStationID(x) {
        x = x.replace("DistanceToNextStationM", "")
        x = x.split("NextStation")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function DistanceToNextStationM(x) {
        x = x.split("DistanceToNextStationM")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function DestinationStation(x) {
        x = x.split("DestinationStation")
        x = x[1].replace(">", "").replace("</", "")
        x = GetStationName(x)
        return x
    }

    function DestinationStationID(x) {
        x = x.split("DestinationStation")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function DoorOpen(x) {
        x = x.split("DoorOpen")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function DoorsClosed(x) {
        x = x.split("DoorsClosed")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function HasChanged(x) {
        x = x.split("HasChanged")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function LastUpdated(x) {
        x = x.split("LastUpdated")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function MaxNumberOfStreams(x) {
        x = x.split("MaxNumberOfStreams")
        x = x[1].replace(">", "").replace("</", "")
        return x
    }

    function rawPacket(x) {
        x = x.split("<CstInfos>")
        x = x[1].split("</CstInfos>")
        x = x[0].replace("</CstInfo>", "")
        x = x.split("<CstInfo>")
        x.shift()
        return x
    }

    // ------ get data from file --------------
    // function parseTextAsXml(text) {

    // }

    var reader;
    var progress = document.querySelector('.percent');

    function abortRead() {
        reader.abort();
    }

    function errorHandler(evt) {
        switch (evt.target.error.code) {
            case evt.target.error.NOT_FOUND_ERR:
                alert('File Not Found!');
                break;
            case evt.target.error.NOT_READABLE_ERR:
                alert('File is not readable');
                break;
            case evt.target.error.ABORT_ERR:
                break; // noop
            default:
                alert('An error occurred reading this file.');
        };
    }

    function updateProgress(evt) {
        // evt is an ProgressEvent.
        if (evt.lengthComputable) {
            var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
            // Increase the progress bar length.
            if (percentLoaded < 100) {
                progress.style.width = percentLoaded + '%';
                progress.textContent = percentLoaded + '%';
            }
        }
    }

    function handleFileSelection(evt) {
        // Reset progress indicator on new file selection.
        document.getElementById("statusCheck").innerHTML = "Loading file..."

        var output = document.getElementById("result");
        progress.style.width = '0%';
        progress.textContent = '0%';
        var file = wsFile.files[0],
            reader = new FileReader();
        reader.onerror = errorHandler;
        reader.onprogress = updateProgress;
        reader.onabort = function (e) {
            alert('File read cancelled');
        };
        reader.onloadstart = function (e) {
            document.getElementById('progress_bar').className = 'loading';
        };
        document.getElementById("statusCheck").innerHTML = "Reading file..."
        reader.onload = function (event) {

            document.getElementById("statusCheck").innerHTML = "Inne i load"


            var text = event.target.result;
            document.getElementById("statusCheck").innerHTML = "Parsing file..."

            var parser = new DOMParser(),
                xmlDoc = parser.parseFromString(text, "text/xml");

            document.getElementById("statusCheck").innerHTML = "Almost done!"


            allPackets = xmlDoc.getElementsByTagName('packet');

            var AmountPackets = 0
            var AmountFields = 0
            var AmountCstInfos = 0
            Array.from(allPackets).forEach((packet, indexPacket) => {
                AmountPackets += 1
                allFields = packet.getElementsByTagName('field');

                packetNumber = packet.getElementsByTagName('field')[0].getAttribute("show")
                packetArrival = packet.getElementsByTagName('field')[3].getAttribute("show");



                Array.from(allFields).forEach((field, indexField) => {
                    AmountFields += 1

                    if (field.getAttribute("name") == "http.file_data") {
                        allInfos = rawPacket(field.getAttribute("show"))
                        Array.from(allInfos).forEach((infos, indexInfo) => {


                            ws_data[AmountCstInfos] = [
                                packetNumber,
                                packetArrival,
                                CstLabel(infos),
                                CstLabels(infos),
                                VehicleModel(infos),
                                CarTypes(infos),
                                BlockId(infos),
                                DrivingDirection(infos),
                                CurrentStationID(infos),
                                CurrentStation(infos),
                                NextStation(infos),
                                NextStationID(infos),
                                DistanceToNextStationM(infos),
                                DestinationStation(infos),
                                DestinationStationID(infos),
                                DoorOpen(infos),
                                DoorsClosed(infos),
                                HasChanged(infos),
                                LastUpdated(infos),
                                MaxNumberOfStreams(infos),
                            ]
                            AmountCstInfos += 1
                        });
                    }

                });

            });

            // Ensure that the progress bar displays 100% at the end.
            //console.log(ws_data)
            CreateTable()
            // document.getElementById("AmountPackets").innerHTML = AmountPackets
            // document.getElementById("AmountFields").innerHTML = AmountFields
            // document.getElementById("AmountCstInfos").innerHTML = AmountCstInfos
            document.getElementById("statusCheck").innerHTML = "Done!"
            progress.style.width = '100%';
            progress.textContent = '100%';
            setTimeout("document.getElementById('progress_bar').className='';", 2000);
        }

        // reader.onloadend = function (event) {

        // }
        reader.readAsText(file);
        // Read in the image file as a binary string.
        //reader.readAsDataURL(evt.target.files[0]);
    }


    // ------ at chosen file --------------
    // function waitForTextReadComplete(reader) {
    //     document.getElementById("statusCheck").innerHTML = "Reading file..."
    //     reader.onloadend = function (event) {
    //         var text = event.target.result;
    //         parseTextAsXml(text);
    //     }
    // }

    // function handleFileSelection() {
    //     document.getElementById("statusCheck").innerHTML = "Loading file..."
    //     var file = wsFile.files[0],
    //         reader = new FileReader();
    //     waitForTextReadComplete(reader);
    //     reader.readAsText(file);
    // }
    wsFile.addEventListener('change', handleFileSelection, false);


    // ------ save file --------------


    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;

    }

    $("#button-save").click(function () {
        var wb = XLSX.utils.book_new()
        wb.SheetNames.push("Test Sheet")
        //var ws_data = [];
        var ws = XLSX.utils.aoa_to_sheet(ws_data)
        wb.Sheets["Test Sheet"] = ws;

        var wbout = XLSX.write(wb, {
            bookType: 'xlsx',
            type: 'binary'
        })

        console.log(ws_data)
        saveAs(new Blob([s2ab(wbout)], {
            type: "application/octet-stream"
        }), 'test.xlsx');
        console.log(ws_data)
    });
</script>

</html>

<style>
    body {
        background-color: #333333;
        color: #fafafa;
        font-family: verdana;
        text-align: center;
    }

    input {
        color: #fafafa;
    }

    h1 {
        color: #fafafa;
    }

    p {
        font-size: 20px;
    }

    table,
    th,
    td {
        border: 1px solid #949494;
        border-collapse: collapse;
    }

    #progress_bar {
        margin: 10px 0;
        padding: 3px;
        border: 1px solid #000;
        font-size: 14px;
        clear: both;
        opacity: 0;
        -moz-transition: opacity 1s linear;
        -o-transition: opacity 1s linear;
        -webkit-transition: opacity 1s linear;
    }

    #progress_bar.loading {
        opacity: 1.0;
    }

    #progress_bar .percent {
        background-color: #99ccff;
        height: auto;
        width: 0;
    }
</style>